#!/usr/bin/env python3
"""
Test script to verify the pentest script works correctly
"""

import os
import sys
import subprocess
import tempfile
import json
from pathlib import Path


def test_pentest_script():
    """Test if the pentest script runs without errors"""
    print("Testing pentest script...")
    
    # Path to the pentest script
    pentest_script = Path("pentest_suedwestenergie.py")
    
    if not pentest_script.exists():
        print(f"❌ Pentest script not found at {pentest_script}")
        return False
    
    # Check if requests library is available
    try:
        import requests
    except ImportError:
        print("❌ requests library not found. Install with: pip install requests")
        return False
    
    print(f"✅ Found pentest script at {pentest_script}")
    
    # Create a temporary output file
    with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as tmp_file:
        temp_output = tmp_file.name
    
    try:
        # Test if the script can be imported without errors
        import importlib.util
        spec = importlib.util.spec_from_file_location("pentest_suedwestenergie", pentest_script)
        pentest_module = importlib.util.module_from_spec(spec)
        
        # This will test that the syntax is correct
        spec.loader.exec_module(pentest_module)
        print("✅ Pentest script syntax is valid")
        
        # Test basic functionality without running full pentest
        # Just verify the main class exists and can be instantiated
        if hasattr(pentest_module, 'SudwestEnergiePentester'):
            print("✅ SudwestEnergiePentester class found")
            
            # Test that the class can be instantiated with mock URL
            tester = pentest_module.SudwestEnergiePentester(base_url="http://invalid-url-for-test.com", timeout=1)
            print("✅ SudwestEnergiePentester class can be instantiated")
            
            # Test that methods exist
            methods_to_check = [
                'check_security_headers',
                'test_xss_vulnerabilities', 
                'test_sql_injection',
                'test_form_validation_bypass',
                'test_ninox_api_integration',
                'test_csrf_vulnerabilities',
                'test_directory_enumeration',
                'test_information_disclosure'
            ]
            
            for method in methods_to_check:
                if hasattr(tester, method):
                    print(f"✅ Method {method} found")
                else:
                    print(f"❌ Method {method} not found")
                    return False
                    
            return True
        else:
            print("❌ SudwestEnergiePentester class not found")
            return False
            
    except SyntaxError as e:
        print(f"❌ Syntax error in pentest script: {e}")
        return False
    except Exception as e:
        print(f"❌ Error testing pentest script: {e}")
        return False
    finally:
        # Clean up temp file
        if os.path.exists(temp_output):
            os.unlink(temp_output)


def main():
    print("Running pentest script verification tests...")
    
    success = test_pentest_script()
    
    if success:
        print("\n✅ All pentest script verification tests passed!")
        print("\nTo run the actual pentest, use:")
        print("python pentest_suedwestenergie.py")
        print("\nFor help with options:")
        print("python pentest_suedwestenergie.py --help")
    else:
        print("\n❌ Pentest script verification tests failed!")
        sys.exit(1)


if __name__ == "__main__":
    main()
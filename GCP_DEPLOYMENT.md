# Google Cloud Platform Deployment Guide

## Overview

Deploying a Reflex application on Google Cloud Platform (GCP) involves two main components:

1.  **Frontend (Static Files)**: Hosted on **Google Cloud Storage (GCS)** (or Firebase Hosting).
2.  **Backend (Python Server)**: Hosted on **Google Cloud Run** (Serverless container).

> **Important**: GCS can *only* host the static frontend. Because your website has dynamic features (Contact Form, Status Page, Tarifrechner logic), you **must** also deploy the Python backend.

---

## Prerequisites

1.  **GCP Project**: Create a project in the Google Cloud Console.
2.  **Billing**: Enable billing for your project.
3.  **gcloud CLI**: Install and authenticate (`gcloud auth login`).
4.  **APIs Enabled**:
    - Cloud Run API
    - Cloud Build API
    - Artifact Registry API

---

## Step 1: Deploy Backend to Cloud Run

The backend handles the application logic, database connections, and API requests.

### 1. Configure for Production
Ensure your `.env` file has production settings:
```env
API_URL=https://api.suedwest-energie.de  # We will update this later
ENVIRONMENT=production
```

### 2. Create `Dockerfile`
(If not already present, create a simple Dockerfile for the backend)

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY . .

RUN pip install -r requirements-prod.txt

# Reflex backend runs on port 8000
CMD ["reflex", "run", "--env", "prod", "--backend-only"]
```

### 3. Build and Deploy
Run the following commands:

```bash
# 1. Set your project ID
export PROJECT_ID=your-project-id
gcloud config set project $PROJECT_ID

# 2. Build the container image
gcloud builds submit --tag gcr.io/$PROJECT_ID/suedwest-backend

# 3. Deploy to Cloud Run
gcloud run deploy suedwest-backend \
  --image gcr.io/$PROJECT_ID/suedwest-backend \
  --platform managed \
  --region europe-west3 \
  --allow-unauthenticated
```

### 4. Get Backend URL
After deployment, Cloud Run will give you a URL (e.g., `https://suedwest-backend-xyz-ew.a.run.app`).
**Save this URL.**

---

## Step 2: Deploy Frontend to Google Cloud Storage

The frontend consists of HTML, CSS, and JavaScript files generated by Reflex.

### 1. Update Configuration
Update your `rxconfig.py` or `.env` to point to your new Backend URL:

```python
# In rxconfig.py or via env var
api_url="https://suedwest-backend-xyz-ew.a.run.app"
```

### 2. Export Static Files
Generate the static build:

```bash
reflex export --frontend-only --no-zip
```
This creates a `_static` (or `public`) directory (check `.web/_static` or output folder).

### 3. Create GCS Bucket
```bash
# Create a public bucket (replace with your domain/name)
gsutil mb -l europe-west3 gs://www.suedwest-energie.de

# Make it publicly readable
gsutil iam ch allUsers:objectViewer gs://www.suedwest-energie.de
```

### 4. Upload Files
```bash
# Upload contents of the exported folder
gsutil -m rsync -r .web/_static gs://www.suedwest-energie.de
```

### 5. Configure Website Hosting
```bash
gsutil web set -m index.html -e 404.html gs://www.suedwest-energie.de
```

---

## Step 3: Connect Domain (DNS)

### Frontend Domain (www.suedwest-energie.de)
1.  Go to **Cloud Storage** > **Buckets**.
2.  Select your bucket.
3.  Go to **Load Balancer** setup (recommended for HTTPS) OR use a CNAME record if using HTTP (not recommended for production).
    *   *Best Practice*: Set up a **Global External Load Balancer** with a backend bucket pointing to your GCS bucket. This gives you HTTPS (SSL) automatically.

### Backend Domain (api.suedwest-energie.de)
1.  Go to **Cloud Run** > **Manage Custom Domains**.
2.  Map `api.suedwest-energie.de` to your Cloud Run service.

---

## Summary

1.  **Backend** runs on **Cloud Run**.
2.  **Frontend** files live in **Cloud Storage**.
3.  **Frontend** talks to **Backend** via the API URL.

### Alternative: Firebase Hosting (Easier)
If GCS seems too complex for SSL setup, **Firebase Hosting** is often easier for the frontend:
1.  `firebase init hosting`
2.  `firebase deploy` (deploys the exported static files)
